{
  "name": "Chat WebSocket Handler (HTTP Bridge)",
  "nodes": [
    {"parameters": {"path": "ws/connect", "responseCode": 200}, "id": "WS_Connect", "name": "WS Connect", "type": "n8n-nodes-base.webhook", "typeVersion": 1, "position": [220, 140]},
    {"parameters": {"path": "ws/message", "responseCode": 200}, "id": "WS_Message", "name": "WS Message", "type": "n8n-nodes-base.webhook", "typeVersion": 1, "position": [220, 300]},
    {"parameters": {"path": "ws/disconnect", "responseCode": 200}, "id": "WS_Disconnect", "name": "WS Disconnect", "type": "n8n-nodes-base.webhook", "typeVersion": 1, "position": [220, 460]},

    {"parameters": {"functionCode": "const b=$json||{};const session=b.sessionId||b.session_id||'ws-'+Date.now();const userId=b.userId||b.user_id||null;return [{json:{sessionId:session,userId}}];"}, "id": "Normalize_Connect", "name": "Normalize Connect", "type": "n8n-nodes-base.function", "typeVersion": 1, "position": [480, 140]},
    {"parameters": {"operation": "executeQuery", "query": "={{`INSERT INTO chat_sessions (session_id, user_id, updated_at) VALUES ('${$json.sessionId}', ${$json.userId ? '\'' + $json.userId + '\'' : 'NULL'}, now()) ON CONFLICT (session_id) DO UPDATE SET user_id = EXCLUDED.user_id, updated_at = now();`}}"}, "id": "PG_Connect_Upsert", "name": "PG Upsert Session (Connect)", "type": "n8n-nodes-base.postgres", "typeVersion": 1, "position": [740, 140]},
    {"parameters": {"functionCode": "return [{json:{ok:true,sessionId:$json.sessionId}}];"}, "id": "Resp_Connect", "name": "Response (Connect)", "type": "n8n-nodes-base.function", "typeVersion": 1, "position": [980, 140]},

    {"parameters": {"functionCode": "const b=$json||{};const session=b.sessionId||b.session_id;const text=b.text||b.message||'';if(!session)throw new Error('sessionId required');if(!text)throw new Error('message required');return [{json:{sessionId:session,text}}];"}, "id": "Normalize_WS_Msg", "name": "Normalize WS Message", "type": "n8n-nodes-base.function", "typeVersion": 1, "position": [480, 300]},
    {"parameters": {"operation": "executeQuery", "query": "={{`INSERT INTO chat_messages (session_id, role, content, created_at) VALUES ('${$json.sessionId}', 'user', '${($json.text||'').replace(/'/g, "''")}', now());`}}"}, "id": "PG_WS_Insert_User", "name": "PG Insert User Msg (WS)", "type": "n8n-nodes-base.postgres", "typeVersion": 1, "position": [740, 300]},
    {"parameters": {"functionCode": "return [{json:{ack:true}}];"}, "id": "Resp_WS_Msg", "name": "Response (WS Message)", "type": "n8n-nodes-base.function", "typeVersion": 1, "position": [980, 300]},

    {"parameters": {"functionCode": "const b=$json||{};const session=b.sessionId||b.session_id;return [{json:{sessionId:session}}];"}, "id": "Normalize_Disconnect", "name": "Normalize Disconnect", "type": "n8n-nodes-base.function", "typeVersion": 1, "position": [480, 460]},
    {"parameters": {"functionCode": "return [{json:{ok:true,sessionId:$json.sessionId}}];"}, "id": "Resp_Disconnect", "name": "Response (Disconnect)", "type": "n8n-nodes-base.function", "typeVersion": 1, "position": [740, 460]}
  ],
  "connections": {
    "WS Connect": {"main": [[{"node": "Normalize Connect", "type": "main", "index": 0}]]},
    "Normalize Connect": {"main": [[{"node": "PG Upsert Session (Connect)", "type": "main", "index": 0}]]},
    "PG Upsert Session (Connect)": {"main": [[{"node": "Response (Connect)", "type": "main", "index": 0}]]},

    "WS Message": {"main": [[{"node": "Normalize WS Message", "type": "main", "index": 0}]]},
    "Normalize WS Message": {"main": [[{"node": "PG Insert User Msg (WS)", "type": "main", "index": 0}]]},
    "PG Insert User Msg (WS)": {"main": [[{"node": "Response (WS Message)", "type": "main", "index": 0}]]},

    "WS Disconnect": {"main": [[{"node": "Normalize Disconnect", "type": "main", "index": 0}]]},
    "Normalize Disconnect": {"main": [[{"node": "Response (Disconnect)", "type": "main", "index": 0}] ]}
  },
  "settings": {"executionOrder": "v1"},
  "tags": ["chat", "websocket", "bridge"],
  "versionId": "chat-websocket-handler-v1"
}
